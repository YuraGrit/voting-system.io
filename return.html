<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–ª–æ–∫–∏ –ë–ª–æ–∫—á–µ–π–Ω—É</title>
  <link rel="stylesheet" href="returnStyle.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <div class="container">
    <h1>üìú –ë–ª–æ–∫–∏ –ë–ª–æ–∫—á–µ–π–Ω—É</h1>
    
    <!-- –§—ñ–ª—å—Ç—Ä–∏ –¥–ª—è –±–ª–æ–∫—ñ–≤ -->
    <div class="filters">
      <div class="filter-group">
        <label for="block-type">–¢–∏–ø –±–ª–æ–∫—É:</label>
        <select id="block-type" class="filter-select">
          <option value="all">–í—Å—ñ –±–ª–æ–∫–∏</option>
          <option value="create_vote">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</option>
          <option value="vote">–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="search-input">–ü–æ—à—É–∫:</label>
        <input type="text" id="search-input" placeholder="ID –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∞–±–æ –≤–∏–±–æ—Ä—Ü—è">
      </div>
      
      <button id="reset-filters" class="reset-btn"><i class="fas fa-sync-alt"></i> –°–∫–∏–Ω—É—Ç–∏</button>
    </div>
    
    <!-- –ö—ñ–ª—å–∫—ñ—Å—Ç—å –±–ª–æ–∫—ñ–≤ —Ç–∞ —Å—Ç–∞—Ç—É—Å –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó -->
    <div class="blockchain-status">
      <div class="block-count">
        <i class="fas fa-cube"></i> <span id="block-count">0</span> –±–ª–æ–∫—ñ–≤ 
      </div>
      <div class="validation-status" id="validation-status">
        <i class="fas fa-spinner fa-spin"></i> –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –ª–∞–Ω—Ü—é–≥–∞...
      </div>
    </div>
    
    <div id="blocks" class="blocks-container">
      <!-- –¢—É—Ç –±—É–¥—É—Ç—å –±–ª–æ–∫–∏ –±–ª–æ–∫—á–µ–π–Ω—É -->
      <div class="loading-spinner"></div>
    </div>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ -->
  <div class="back">
    <a href="./"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –¥–æ –ø–∞–Ω–µ–ª—ñ</a>
  </div>

  <script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏
    const BLOCKCHAIN_API_URL = 'https://blockchain-io-ffel.onrender.com';
    
    // –°—Ç–∞–Ω –¥–æ–¥–∞—Ç–∫—É
    let allBlocks = [];
    let filteredBlocks = [];
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é
    document.addEventListener('DOMContentLoaded', function() {
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ç–æ–∫–µ–Ω–∞
      const token = localStorage.getItem('session_token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±–ª–æ–∫—á–µ–π–Ω
      fetchBlockchain();
      
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å –ª–∞–Ω—Ü—é–≥–∞
      validateBlockchain();
      
      // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
      document.getElementById('block-type').addEventListener('change', applyFilters);
      document.getElementById('search-input').addEventListener('input', applyFilters);
      document.getElementById('reset-filters').addEventListener('click', resetFilters);
    });
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–ª–æ–∫—á–µ–π–Ω—É
    async function fetchBlockchain() {
      try {
        const response = await fetch(`${BLOCKCHAIN_API_URL}/chain`);
        const blockchain = await response.json();
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—Å—ñ –±–ª–æ–∫–∏
        allBlocks = blockchain;
        
        // –°–æ—Ä—Ç—É—î–º–æ –±–ª–æ–∫–∏ –∑–∞ —á–∞—Å–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
        allBlocks.sort((a, b) => {
          const dateA = a.creationDate || a.timestamp;
          const dateB = b.creationDate || b.timestamp;
          return new Date(dateA) - new Date(dateB);
        });
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –±–ª–æ–∫—ñ–≤
        document.getElementById('block-count').textContent = allBlocks.length;
        
        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –±–ª–æ–∫–∏
        applyFilters();
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –±–ª–æ–∫—á–µ–π–Ω—É:', error);
        document.getElementById('blocks').innerHTML = 
          '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö –±–ª–æ–∫—á–µ–π–Ω—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π —Å–µ—Ä–≤–µ—Ä.</p>';
      }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ –±–ª–æ–∫—á–µ–π–Ω—É
    async function validateBlockchain() {
      try {
        const response = await fetch(`${BLOCKCHAIN_API_URL}/validate`);
        const validationResult = await response.json();
        
        const validationStatusElement = document.getElementById('validation-status');
        
        if (validationResult.valid) {
          validationStatusElement.innerHTML = '<i class="fas fa-check-circle"></i> –õ–∞–Ω—Ü—é–≥ –≤–∞–ª—ñ–¥–Ω–∏–π';
          validationStatusElement.className = 'validation-status valid';
        } else {
          validationStatusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${validationResult.message}`;
          validationStatusElement.className = 'validation-status invalid';
        }
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ –±–ª–æ–∫—á–µ–π–Ω—É:', error);
        const validationStatusElement = document.getElementById('validation-status');
        validationStatusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ';
        validationStatusElement.className = 'validation-status invalid';
      }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    function applyFilters() {
      const blockType = document.getElementById('block-type').value;
      const searchQuery = document.getElementById('search-input').value.toLowerCase();
      
      // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –±–ª–æ–∫–∏
      filteredBlocks = allBlocks.filter(block => {
        // –§—ñ–ª—å—Ç—Ä –∑–∞ —Ç–∏–ø–æ–º –±–ª–æ–∫—É
        if (blockType !== 'all' && block.type !== blockType) {
          return false;
        }
        
        // –ü–æ—à—É–∫ –∑–∞ –≤–º—ñ—Å—Ç–æ–º
        if (searchQuery) {
          const matchesVoteId = block.voteId && block.voteId.toString().toLowerCase().includes(searchQuery);
          const matchesVoterId = block.voterId && block.voterId.toString().toLowerCase().includes(searchQuery);
          const matchesTitle = block.title && block.title.toLowerCase().includes(searchQuery);
          
          return matchesVoteId || matchesVoterId || matchesTitle;
        }
        
        return true;
      });
      
      // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ –±–ª–æ–∫–∏
      renderBlocks(filteredBlocks);
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    function resetFilters() {
      document.getElementById('block-type').value = 'all';
      document.getElementById('search-input').value = '';
      
      // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏
      applyFilters();
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–ª–æ–∫—ñ–≤
    function renderBlocks(blocks) {
      const container = document.getElementById('blocks');
      container.innerHTML = '';
      
      if (blocks.length === 0) {
        container.innerHTML = '<p class="empty-results">–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –±–ª–æ–∫—É –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏.</p>';
        return;
      }
      
      for (let i = 0; i < blocks.length; i++) {
        const block = blocks[i];
        const blockDiv = document.createElement('div');
        blockDiv.className = `block ${block.type === 'vote' ? 'vote-block' : 'create-vote-block'}`;
        
        // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–º—ñ—Å—Ç –±–ª–æ–∫—É (–∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∏–π)
        const blockSummary = document.createElement('div');
        blockSummary.className = 'block-summary';
        
        // –î–µ—Ç–∞–ª—ñ –±–ª–æ–∫—É (—Å—Ö–æ–≤–∞–Ω—ñ, —Ä–æ–∑–≥–æ—Ä—Ç–∞—é—Ç—å—Å—è –ø—Ä–∏ –∫–ª—ñ–∫—É)
        const blockDetails = document.createElement('div');
        blockDetails.className = 'block-details';
        
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –±–µ–π–¥–∂—É
        const badgeClass = block.type === 'vote' ? 'badge-vote' : 'badge-create';
        const badgeText = block.type === 'vote' ? '–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è' : '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è';
        
        // –†—ñ–∑–Ω–∏–π –≤–∏–≤—ñ–¥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ç–∏–ø—É –±–ª–æ–∫—É
        if (block.type === 'create_vote') {
          blockSummary.innerHTML = `
            <div class="block-header">
              <strong>–ë–ª–æ–∫ #${i + 1} <span class="block-badge ${badgeClass}">${badgeText}</span></strong>
              <span>${new Date(block.creationDate || block.timestamp).toLocaleString()}</span>
            </div>
            <p>ID –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è: ${block.voteId}</p>
            <p>–ù–∞–∑–≤–∞: ${block.title}</p>
            <div class="toggle-icon">‚ñº</div>
          `;
          
          // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è (–ø—É–±–ª—ñ—á–Ω–µ —á–∏ –≥—Ä—É–ø–æ–≤–µ)
          const isPublic = Array.isArray(block.groupIds) && block.groupIds.includes("all");
          const voteTypeClass = isPublic ? 'type-public' : 'type-group';
          const voteType = isPublic ? '–ü—É–±–ª—ñ—á–Ω–µ' : '–ì—Ä—É–ø–æ–≤–µ';
          
          blockDetails.innerHTML = `
            <div class="block-body">
              <div class="block-section">
                <div class="section-title">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</div>
                <p>–û–ø–∏—Å: ${block.description}</p>
                <p>ID –∞–≤—Ç–æ—Ä–∞: ${block.creatorId}</p>
                <p>–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è: ${new Date(block.endDate).toLocaleString()}</p>
                <p>–¢–∏–ø –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è: <span class="vote-type ${voteTypeClass}">${voteType}</span></p>
              </div>
              <div class="block-section">
                <div class="section-title">–í–∞—Ä—ñ–∞–Ω—Ç–∏:</div>
                <ul>
                  ${block.options.map(option => `<li>${option}</li>`).join('')}
                </ul>
                <div class="section-title">–•–µ—à—ñ:</div>
                <p class="hash">Hash: ${block.hash}</p>
                <p class="hash">Previous Hash: ${block.previousHash}</p>
              </div>
            </div>
          `;
        } else { // –î–ª—è –±–ª–æ–∫—ñ–≤ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è
          blockSummary.innerHTML = `
            <div class="block-header">
              <strong>–ë–ª–æ–∫ #${i + 1} <span class="block-badge ${badgeClass}">${badgeText}</span></strong>
              <span>${new Date(block.creationDate || block.timestamp).toLocaleString()}</span>
            </div>
            <p>ID –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è: ${block.voteId}</p>
            <p>ID –≤–∏–±–æ—Ä—Ü—è: ${block.voterId}</p>
            <div class="toggle-icon">‚ñº</div>
          `;

          blockDetails.innerHTML = `
            <div class="block-body">
              <div class="block-section">
                <div class="section-title">–î–µ—Ç–∞–ª—ñ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è:</div>
                <p>–û–±—Ä–∞–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç: <strong>${block.candidate || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</strong></p>
              </div>
              <div class="block-section">
                <div class="section-title">–•–µ—à—ñ:</div>
                <p class="hash">Hash: ${block.hash}</p>
                <p class="hash">Previous Hash: ${block.previousHash}</p>
              </div>
            </div>
          `;
        }
        
        blockDiv.appendChild(blockSummary);
        blockDiv.appendChild(blockDetails);
        
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π
        blockDiv.addEventListener('click', function(e) {
          // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∑–∞–∫—Ä–∏—Ç—Ç—é –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –≤–º—ñ—Å—Ç –±–ª–æ–∫—É
          if (e.target.closest('.block-details') && !e.target.closest('.section-title')) {
            return;
          }
          this.classList.toggle('expanded');
        });
        
        container.appendChild(blockDiv);
      }
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      fetchBlockchain();
      validateBlockchain();
    }, 30000);
  </script>

</body>
</html>
